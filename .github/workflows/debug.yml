name: üîç COMPLETE DEBUG

on:
  push:
    branches: [ main ]

jobs:
  debug:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      
    - name: 1Ô∏è‚É£ Verify Secrets Exist
      run: |
        echo "üîç Verificando secrets..."
        echo "SSH_HOST: ${{ secrets.SSH_HOST }}"
        echo "SSH_USERNAME: ${{ secrets.SSH_USERNAME }}"
        if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
          echo "‚ùå SSH_PRIVATE_KEY est√° VAC√çO"
          exit 1
        else
          echo "‚úÖ SSH_PRIVATE_KEY tiene contenido"
          # Verificar formato de la clave
          echo "${{ secrets.SSH_PRIVATE_KEY }}" | head -1 | grep -q "BEGIN OPENSSH PRIVATE KEY" && echo "‚úÖ Formato correcto" || echo "‚ùå Formato incorrecto"
        fi
        
    - name: 2Ô∏è‚É£ Create SSH Files
      run: |
        echo "üîß Creando archivos SSH..."
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        
        echo "üìÑ Verificando archivo:"
        ls -la ~/.ssh/id_rsa
        echo "Primeras l√≠neas:"
        head -3 ~/.ssh/id_rsa
        
    - name: 3Ô∏è‚É£ Test Basic Connectivity
      run: |
        echo "üåê Probando conectividad b√°sica..."
        ping -c 2 -W 5 ${{ secrets.SSH_HOST }} || echo "‚ö†Ô∏è Ping fall√≥"
        nc -zv -w 5 ${{ secrets.SSH_HOST }} 22 || echo "‚ùå Puerto 22 cerrado"
        
    - name: 4Ô∏è‚É£ Test SSH Connection
      run: |
        echo "üîå Probando conexi√≥n SSH..."
        ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no -o BatchMode=yes \
          ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} \
          "echo '‚úÖ SSH EXITOSO'; whoami; pwd; ls -la" \
          || echo "‚ùå SSH FALL√ì - Exit code: $?"
          
    - name: 5Ô∏è‚É£ Final Status
      run: |
        echo "üèÅ DEBUG COMPLETADO"
        echo "Revisa los pasos anteriores para ver d√≥nde falla exactamente"
