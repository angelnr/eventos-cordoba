name: üöÄ DEPLOY EMERGENCY - Public IP

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      
    - name: üîë Setup SSH Connection
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        # Usar IP p√∫blica directamente
        ssh-keyscan -H 171.33.234.226 >> ~/.ssh/known_hosts 2>/dev/null
        
    - name: üß™ Test Basic Connection
      run: |
        echo "üîå Probando conexi√≥n SSH b√°sica..."
        ssh -o ConnectTimeout=10 -o BatchMode=yes deploy@171.33.234.226 "echo '‚úÖ SSH funciona' && whoami && pwd"
        
    - name: üöÄ Full Deploy
      run: |
        ssh deploy@171.33.234.226 "
          set -e
          echo 'üöÄ INICIANDO DESPLIEGUE...'
          
          echo '1Ô∏è‚É£ Actualizando c√≥digo...'
          cd /home/deploy/eventoscordoba
          git fetch origin
          git reset --hard origin/main
          
          echo '2Ô∏è‚É£ Verificando servicios locales...'
          sudo netstat -tlnp | grep -E ':(3000|3001|22)' || echo '‚ö†Ô∏è Algunos servicios no est√°n escuchando'
          
          echo '3Ô∏è‚É£ Reiniciando contenedores...'
          docker-compose down
          docker-compose up -d --build
          
          echo '4Ô∏è‚É£ Esperando que servicios inicien...'
          sleep 10
          
          echo '5Ô∏è‚É£ Estado final:'
          docker ps
          echo '‚úÖ DESPLIEGUE COMPLETADO - eventoscordoba.xyz actualizado'
        "
